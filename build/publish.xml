<?xml version="1.0"?>
<project name="PHPFrame" basedir="../" default="build">
	
	<property name="build.dir" value="${project.basedir}/build"/>
	<property name="dist.dir" value="${build.dir}/dist"/>
	<property name="tmp.dir" value="${build.dir}/tmp"/>
	<property name="report.dir" value="${build.dir}/report"/>
	
	<property name="api.version" value="0.0.1" />
	<property name="api.stability" value="alpha" />
	
	<property name="release.version" value="0.0.1" />
	<property name="release.stability" value="alpha" />
	
	<target name="prepare">
		<mkdir dir="${dist.dir}"/>
		
		<delete dir="${tmp.dir}" includeemptydirs="true" verbose="true" failonerror="true" />
		<mkdir dir="${tmp.dir}"/>
		
		<php function="date" returnProperty="date">
		  <param value="Y-m-d"/>
		</php>
		<php function="date" returnProperty="time">
		  <param value="h:i:s"/>
		</php>
	</target>
	
	<!-- copy files to tmp dir for publishing -->
	<target name="copy">
		<!-- copy data files -->
		<copy todir="${tmp.dir}" overwrite="true">
			<fileset dir="${project.basedir}/data">
				<include name="**" />
			</fileset>
		</copy>
		
		<!-- copy script files -->
		<copy todir="${tmp.dir}" overwrite="true">
			<fileset dir="${project.basedir}/scripts">
				<include name="**" />
			</fileset>
		</copy>
		
		<!-- copy source files -->
		<copy todir="${tmp.dir}" overwrite="true">
			<fileset dir="${project.basedir}/src">
				<include name="**" />
			</fileset>
		</copy>
		
		<!-- copy package.xml to use as template -->
		<copy todir="${tmp.dir}" overwrite="true">
			<!-- Replace tokens -->
			<filterchain>
				<replacetokens begintoken="##" endtoken="##">
					<token key="PROJECT_NAME" value="${xinc.project.name}" />
					
					<token key="RELEASE_VERSION" value="${release.version}" />
					<token key="RELEASE_STABILITY" value="${release.stability}" />
					<token key="API_VERSION" value="${api.version}" />
					<token key="API_STABILITY" value="${api.stability}" />
					
					<token key="DATE" value="${date}" />
					<token key="TIME" value="${time}" />
				</replacetokens>
			</filterchain>
			
			<fileset dir="${build.dir}">
				<include name="package.xml" />
			</fileset>
		</copy>
		
		<!-- copy info files -->
		<copy file="${project.basedir}/CREDITS" tofile="${tmp.dir}/CREDITS" overwrite="true" />
		<copy file="${project.basedir}/LICENSE" tofile="${tmp.dir}/LICENSE" overwrite="true" />
		<copy file="${project.basedir}/README" tofile="${tmp.dir}/README" overwrite="true" />
		
	</target>
	
	<!-- Create archive for distribution -->
	<target name="tar">
		<!-- create tar using pear package command -->
		<exec 
			command="pear package" 
			dir="${tmp.dir}" 
			output="${report.dir}/pear_package.log" />
		
		<!-- Move created package to dist directory -->
		<move file="${tmp.dir}/${xinc.project.name}-${release.version}.tgz" 
			  tofile="${dist.dir}/${xinc.project.name}-${xinc.build.label}.tgz" 
			  overwrite="true"/>
			  
	</target>
	
	<target name="build" depends="prepare, copy, tar" />
	
</project>
